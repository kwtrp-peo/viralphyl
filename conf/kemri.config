/*
* --------------------------------------------------------------
*   Profile config names for viraphyl hpc adopted from:
*   https://github.com/nf-core/configs/tree/master/conf
* --------------------------------------------------------------
*/

params {
    config_profile_name        = 'kemri'
    config_profile_description = 'KWTRP HPC profile provided by kwtrp-peo'
    config_profile_contact     = 'Samuel Odoyo (@sodoyo)'
    config_profile_url         = 'kwtrp-peo github page'

    singularity_cache_dir      = "/scratch/.singularityCache"
}

// Specify the job scheduler
executor {
    name            = 'slurm'
    queueSize       = 20
    submitRateLimit = '6/1min'
}

singularity {
    enabled    = true
    autoMounts = true
    // runOptions = '-B /shared:/shared'
    cacheDir   =  params.singularity_cache_dir

}

process {
    resourceLimits = [
        memory: 256.GB,
        cpus: 20,
        time: 24.h
    ]
    
    // beforeScript = 'module load singularity/3.2.1'    // load singularity in hpc
    // beforeScript = 'export PATH=/usr/bin:$PATH'       // providing path
    // conda create -n singularity-env -c conda-forge singularity
    beforeScript = 'eval "$(conda shell.bash hook)" && conda activate singularity-env' // using conda environment
    scratch                     = true
    submitRateLimit             = '10/sec'
    queue = { task.memory <= 250.GB ? (task.time <= 24.h ? 'highmem' : 'longrun') : 'highmem' }
    maxForks = 100
    queueStatInterval           = '10 min'
    maxRetries                  = 3
    errorStrategy               = { task.attempt <= 3 ? 'retry' : 'finish' }
    cache                       = 'lenient'
    exitStatusReadTimeoutMillis = '2700000'
}
